{{ block "page-sketch-lister" . }}
<!DOCTYPE html>
<html lang="{{ .Lang }}" {{ if and .Theme (ne .Theme "system" ) }}data-theme="{{ .Theme }}" {{ end }}>

<head>
  {{ template "html-head" . }}
</head>

<body class="pl-8">
    {{ template "sidebar" . }}
    <main class="h-full">
        <div class="h-full flex flex-col md:flex-row">
            <div class="p-4 flex flex-col md:py-8">
                <div class="flex justify-between items-start md:flex-col">
                    <h1 class="mb-4 ccb-h2">sketches</h1>
                </div>
                <ul id="sketch-lister" class="space-y-2 max-h-30 overflow-y-scroll md:max-w-50 md:flex-1 md:max-h-full">
                    {{ if .Members }}
                    {{ range .Members }}
                    {{ if .Sketches }}
                    {{ range .Sketches }}
                    <li>
                        <button class="ccb-link" data-alias="{{ .Alias }}" data-page="{{ .Name }}"
                            data-title="{{ .Title }}"
                            data-description="{{ .Description }}">{{ .Alias }}/{{ .Name }}</button>
                    </li>
                    {{ end }}
                    {{ else }}
                    <p class="no-sketches">{{ i18nText $.Lang "sketchLister.noSketchesByMember" .Name }}</p>
                    {{ end }}
                    {{ end }}
                    {{ else }}
                    <p>{{ i18nText .Lang "sketchLister.noMembers" }}</p>
                    {{ end }}
                </ul>
            </div>
            <div class="m-2 flex-1 shadow-2xl rounded-2xl flex flex-col md:m-8">
                <div id="viewport" class="flex-1 rounded-t-2xl relative max-h-[55vh] md:max-h-[75vh]">
                    <iframe id="sketch-view" src="/_example/loading" class="w-full h-full z-10"></iframe>
                </div>
                <div class="p-4 border-t-3 border-neutral-400 border-dashed max-h-[20vh] overflow-auto">
                    <p id="sketch-title">...</p>
                    <p id="sketch-description">...</p>
                    <a id="sketch-link" href="/_example/loading" target="_blank" class="ccb-link">open</a>
                </div>
            </div>
        </div>
    </main>
    <script>
        const sketchListerEl = document.getElementById('sketch-lister');
        const sketchViewEl = document.getElementById('sketch-view');
        const sketchTitleEl = document.getElementById('sketch-title');
        const sketchDescriptionEl = document.getElementById('sketch-description');
        const sketchLinkEl = document.getElementById('sketch-link');

        // Helper function to get sketch metadata from DOM element
        function getSketchData(button) {
            const alias = button.dataset.alias;
            const page = button.dataset.page;

            if (!alias || !page) {
                console.warn(`Sketch button for "${button.innerText}" is missing essential data attributes (data-alias or data-page). This sketch cannot be loaded.`);
                return null;
            }
            const title = button.dataset.title || page; // Fallback title to page name
            const description = button.dataset.description || ""; // Default to empty string

            return {
                params: { alias, page },
                props: { metadata: { title, description } }
            };
        }

        function loadSketch(s) {
            console.log(`Loading sketch: ${s.params.alias}/${s.params.page}`);
            const sketchPageUrl = `/members/${s.params.alias}/${s.params.page}`;
            sketchViewEl.setAttribute('src', sketchPageUrl);
            sketchTitleEl.innerHTML = s.props?.metadata?.title || 'Untitled Sketch';
            sketchDescriptionEl.innerHTML = s.props?.metadata?.description || 'No description available.';
            sketchLinkEl.setAttribute('href', sketchPageUrl);
        }

        // Event delegation for sketch lister clicks
        sketchListerEl.addEventListener('click', (event) => {
            const button = event.target.closest('button.ccb-link');
            if (button && sketchListerEl.contains(button)) {
                const sketchData = getSketchData(button);
                if (sketchData) {
                    loadSketch(sketchData);
                }
            }
        });

        // Initial random sketch loading
        // sketchElements are guaranteed to have data-alias and data-page due to the selector
        const sketchElements = sketchListerEl.querySelectorAll('button.ccb-link[data-alias][data-page]');

        if (sketchElements.length > 0) {
            const randomIndex = Math.floor(Math.random() * sketchElements.length);
            const randomButton = sketchElements[randomIndex];
            const randomSketchData = getSketchData(randomButton);

            if (randomSketchData) {
                loadSketch(randomSketchData);
            } else {
                console.warn("Could not create data for a randomly selected sketch button.");
            }
        } else {
            console.log("No sketches with required data-alias and data-page found.");
        }
    </script>
</body>

</html>
{{ end }}